/*** Generated by streamline 0.6.0 (callbacks) - DO NOT EDIT ***/ var __rt=require('streamline/lib/callbacks/runtime').runtime(__filename),__func=__rt.__func,__cb=__rt.__cb,__tryCatch=__rt.__tryCatch; require("../lib/fakes");

module.exports = function upload(stream, idOrPath, tag, _) { var blob, tx, blobId, file, previousId, version, splitPath, fileName, newId, q; var __frame = { name: "upload", line: 3 }; return __func(_, this, arguments, upload, 3, __frame, function __$upload() {
    blob = blobManager.create(account);
    tx = db.begin(); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$upload() {

          return blob.put(stream, __cb(_, __frame, 4, 22, function ___(__0, __1) { blobId = __1;
            return self.byUuidOrPath(idOrPath).get(__cb(_, __frame, 5, 20, function ___(__0, __2) { file = __2;
              previousId = (file ? file.version : null);
              version = {
                userAccountId: userAccount.id,
                date: new Date(),
                blobId: blobId,
                creatorId: userAccount.id,
                previousId: previousId };

              version.id = Version.createHash(version);
              return Version.insert(version).execWithin(tx, __cb(_, __frame, 15, 8, function __$upload() { return (function __$upload(__then) {
                  if (!file) {
                    splitPath = idOrPath.split("/");
                    fileName = splitPath[(splitPath.length - 1)];
                    newId = uuid.v1();
                    file = {
                      id: newId,
                      userAccountId: userAccount.id,
                      name: fileName,
                      version: version.id };

                    return self.createQuery(idOrPath, file, __cb(_, __frame, 26, 21, function ___(__0, __3) { q = __3;
                      return q.execWithin(tx, __cb(_, __frame, 27, 13, __then, true)); }, true)); } else { __then(); } ; })(function __$upload() {


                  return FileVersion.insert({ fileId: file.id, versionId: version.id }).execWithin(tx, __cb(_, __frame, 30, 8, function __$upload() {

                    return File.whereUpdate({ id: file.id }, { version: version.id }).execWithin(tx, __cb(_, __frame, 32, 8, function __$upload() {
                      return tx.commit(__cb(_, __frame, 33, 8, __then, true)); }, true)); }, true)); }); }, true)); }, true)); }, true)); }); })(function ___(err, __result) { __tryCatch(_, function __$upload() { if (err) {

            tx.rollback();
            return _(err); } else { _(null, __result); } ; }); }); })(function ___() { __tryCatch(_, _); }); });};